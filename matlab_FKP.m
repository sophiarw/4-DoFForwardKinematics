
function [] = matlab_FKP(q1, q2, q3, q4)
%Forward kinematics for a 4-DoF parallel robot. The function takes in the
%leg angles and prints the possible x, y, z, and theta positions. It is possible 
%that the numerical solver will not converge, even if the leg angles are
%in the acessible workspace. In this case, the function will not return
%a solution. If all motor values of the motor angles are exactly 0, the 
%system looses rank and is no longer solvable.

if (q1 == q2) && (q2 == q3) && (q3 == q4)
    msg = 'All values of q are the same. Cannot solve.';
    error(msg)
end

[d, d1, h, h1, Li, li, xa, ya, za, ~, ~, phi, ~, ~] = joint_constants();

x1 = -(d1 + d/2 - xa - Li*cos(phi(1))*cos(q1));
y1 = -(h1 -ya - Li*sin(phi(1))*cos(q1));
z1 = -(Li*sin(q1)-za);

x2 = -(-d1 - d/2 + xa - Li*cos(phi(2))*cos(q2));
y2 = -(h1 - ya - Li*sin(phi(2))*cos(q2));
z2 = -(Li*sin(q2)-za);

x3 = -(-d1 - d/2 + xa- Li*cos(phi(3))*cos(q3));
y3 = -(-h1 + ya - Li*sin(phi(3))*cos(q3));
z3 = -(Li*sin(q3)-za);

x4 = -(d1 + d/2 - xa - Li*cos(phi(4))*cos(q4));
y4 = -(-h1 + ya - Li*sin(phi(4))*cos(q4));
z4 = -(Li*sin(q4)-za);

l = li;

coeff_denom = [x3.*y2.*z1+(-1).*x4.*y2.*z1+(-1).*x2.*y3.*z1+x4.*y3.*z1+x2.*y4.* ...
  z1+(-1).*x3.*y4.*z1+(-1).*x3.*y1.*z2+x4.*y1.*z2+x1.*y3.*z2+(-1).* ...
  x4.*y3.*z2+(-1).*x1.*y4.*z2+x3.*y4.*z2+x2.*y1.*z3+(-1).*x4.*y1.* ...
  z3+(-1).*x1.*y2.*z3+x4.*y2.*z3+x1.*y4.*z3+(-1).*x2.*y4.*z3+(-1).* ...
  x2.*y1.*z4+x3.*y1.*z4+x1.*y2.*z4+(-1).*x3.*y2.*z4+(-1).*x1.*y3.* ...
  z4+x2.*y3.*z4,h.*(x4.*(z1+(-1).*z2)+x3.*((-1).*z1+z2)+(x1+(-1).* ...
  x2).*(z3+(-1).*z4)),h.*(y4.*(z1+(-1).*z2)+y3.*((-1).*z1+z2)+(y1+( ...
  -1).*y2).*(z3+(-1).*z4))];

ad = coeff_denom(1);
bd = coeff_denom(2);
cd = coeff_denom(3);

coeff_x = [x3.^2.*y2.*z1+(-1).*x4.^2.*y2.*z1+(-1).*x2.^2.*y3.*z1+x4.^2.*y3.* ...
  z1+(-1).*y2.^2.*y3.*z1+y2.*y3.^2.*z1+x2.^2.*y4.*z1+(-1).*x3.^2.* ...
  y4.*z1+y2.^2.*y4.*z1+(-1).*y3.^2.*y4.*z1+(-1).*y2.*y4.^2.*z1+y3.* ...
  y4.^2.*z1+(-1).*x3.^2.*y1.*z2+x4.^2.*y1.*z2+x1.^2.*y3.*z2+(-1).* ...
  x4.^2.*y3.*z2+y1.^2.*y3.*z2+(-1).*y1.*y3.^2.*z2+(-1).*x1.^2.*y4.* ...
  z2+x3.^2.*y4.*z2+(-1).*y1.^2.*y4.*z2+y3.^2.*y4.*z2+y1.*y4.^2.*z2+( ...
  -1).*y3.*y4.^2.*z2+y3.*z1.^2.*z2+(-1).*y4.*z1.^2.*z2+(-1).*y3.* ...
  z1.*z2.^2+y4.*z1.*z2.^2+x2.^2.*y1.*z3+(-1).*x4.^2.*y1.*z3+(-1).* ...
  x1.^2.*y2.*z3+x4.^2.*y2.*z3+(-1).*y1.^2.*y2.*z3+y1.*y2.^2.*z3+ ...
  x1.^2.*y4.*z3+(-1).*x2.^2.*y4.*z3+y1.^2.*y4.*z3+(-1).*y2.^2.*y4.* ...
  z3+(-1).*y1.*y4.^2.*z3+y2.*y4.^2.*z3+(-1).*y2.*z1.^2.*z3+y4.* ...
  z1.^2.*z3+y1.*z2.^2.*z3+(-1).*y4.*z2.^2.*z3+y2.*z1.*z3.^2+(-1).* ...
  y4.*z1.*z3.^2+(-1).*y1.*z2.*z3.^2+y4.*z2.*z3.^2+(-1).*x2.^2.*y1.* ...
  z4+x3.^2.*y1.*z4+x1.^2.*y2.*z4+(-1).*x3.^2.*y2.*z4+y1.^2.*y2.*z4+( ...
  -1).*y1.*y2.^2.*z4+(-1).*x1.^2.*y3.*z4+x2.^2.*y3.*z4+(-1).*y1.^2.* ...
  y3.*z4+y2.^2.*y3.*z4+y1.*y3.^2.*z4+(-1).*y2.*y3.^2.*z4+y2.*z1.^2.* ...
  z4+(-1).*y3.*z1.^2.*z4+(-1).*y1.*z2.^2.*z4+y3.*z2.^2.*z4+y1.* ...
  z3.^2.*z4+(-1).*y2.*z3.^2.*z4+(-1).*y2.*z1.*z4.^2+y3.*z1.*z4.^2+ ...
  y1.*z2.*z4.^2+(-1).*y3.*z2.*z4.^2+(-1).*y1.*z3.*z4.^2+y2.*z3.* ...
  z4.^2,(-1).*h.*(x2.*y3.*z1+(-1).*x2.*y4.*z1+(-1).*x1.*y3.*z2+x1.* ...
  y4.*z2+(-1).*x2.*y1.*z3+x1.*y2.*z3+(-1).*x1.*y4.*z3+x2.*y4.*z3+ ...
  x4.*((-1).*y2.*z1+y3.*z1+y1.*z2+(-1).*y3.*z2+(-1).*y1.*z3+y2.*z3)+ ...
  x2.*y1.*z4+(-1).*x1.*y2.*z4+x1.*y3.*z4+(-1).*x2.*y3.*z4+x3.*((-1) ...
  .*y4.*z1+(-1).*y1.*z2+y4.*z2+y2.*(z1+(-1).*z4)+y1.*z4)),h.^2.*( ...
  y4.*(z1+(-1).*z2)+y3.*((-1).*z1+z2)+(-1).*(y1+(-1).*y2).*(z3+(-1) ...
  .*z4)),(-1).*x3.^2.*z1+x4.^2.*z1+2.*y2.*y3.*z1+(-1).*y3.^2.*z1+( ...
  -2).*y2.*y4.*z1+y4.^2.*z1+x3.^2.*z2+(-1).*x4.^2.*z2+(-2).*y1.*y3.* ...
  z2+y3.^2.*z2+2.*y1.*y4.*z2+(-1).*y4.^2.*z2+x1.^2.*z3+(-1).*x2.^2.* ...
  z3+y1.^2.*z3+(-1).*y2.^2.*z3+(-2).*y1.*y4.*z3+2.*y2.*y4.*z3+ ...
  z1.^2.*z3+(-1).*z2.^2.*z3+(-1).*z1.*z3.^2+z2.*z3.^2+(-1).*x1.^2.* ...
  z4+x2.^2.*z4+(-1).*y1.^2.*z4+y2.^2.*z4+2.*y1.*y3.*z4+(-2).*y2.* ...
  y3.*z4+(-1).*z1.^2.*z4+z2.^2.*z4+z1.*z4.^2+(-1).*z2.*z4.^2,h.*( ...
  x3.*(z1+(-1).*z2)+x4.*((-1).*z1+z2)+(x1+(-1).*x2).*(z3+(-1).*z4)) ...
  ];


ax = coeff_x(1);
bx = coeff_x(2);
cx = coeff_x(3);
dx = coeff_x(4);
ex = coeff_x(5);


coeff_y = [x2.^2.*x3.*z1+(-1).*x2.*x3.^2.*z1+(-1).*x2.^2.*x4.*z1+x3.^2.*x4.* ...
  z1+x2.*x4.^2.*z1+(-1).*x3.*x4.^2.*z1+x3.*y2.^2.*z1+(-1).*x4.* ...
  y2.^2.*z1+(-1).*x2.*y3.^2.*z1+x4.*y3.^2.*z1+x2.*y4.^2.*z1+(-1).* ...
  x3.*y4.^2.*z1+(-1).*x1.^2.*x3.*z2+x1.*x3.^2.*z2+x1.^2.*x4.*z2+(-1) ...
  .*x3.^2.*x4.*z2+(-1).*x1.*x4.^2.*z2+x3.*x4.^2.*z2+(-1).*x3.* ...
  y1.^2.*z2+x4.*y1.^2.*z2+x1.*y3.^2.*z2+(-1).*x4.*y3.^2.*z2+(-1).* ...
  x1.*y4.^2.*z2+x3.*y4.^2.*z2+(-1).*x3.*z1.^2.*z2+x4.*z1.^2.*z2+x3.* ...
  z1.*z2.^2+(-1).*x4.*z1.*z2.^2+x1.^2.*x2.*z3+(-1).*x1.*x2.^2.*z3+( ...
  -1).*x1.^2.*x4.*z3+x2.^2.*x4.*z3+x1.*x4.^2.*z3+(-1).*x2.*x4.^2.* ...
  z3+x2.*y1.^2.*z3+(-1).*x4.*y1.^2.*z3+(-1).*x1.*y2.^2.*z3+x4.* ...
  y2.^2.*z3+x1.*y4.^2.*z3+(-1).*x2.*y4.^2.*z3+x2.*z1.^2.*z3+(-1).* ...
  x4.*z1.^2.*z3+(-1).*x1.*z2.^2.*z3+x4.*z2.^2.*z3+(-1).*x2.*z1.* ...
  z3.^2+x4.*z1.*z3.^2+x1.*z2.*z3.^2+(-1).*x4.*z2.*z3.^2+(-1).* ...
  x1.^2.*x2.*z4+x1.*x2.^2.*z4+x1.^2.*x3.*z4+(-1).*x2.^2.*x3.*z4+(-1) ...
  .*x1.*x3.^2.*z4+x2.*x3.^2.*z4+(-1).*x2.*y1.^2.*z4+x3.*y1.^2.*z4+ ...
  x1.*y2.^2.*z4+(-1).*x3.*y2.^2.*z4+(-1).*x1.*y3.^2.*z4+x2.*y3.^2.* ...
  z4+(-1).*x2.*z1.^2.*z4+x3.*z1.^2.*z4+x1.*z2.^2.*z4+(-1).*x3.* ...
  z2.^2.*z4+(-1).*x1.*z3.^2.*z4+x2.*z3.^2.*z4+x2.*z1.*z4.^2+(-1).* ...
  x3.*z1.*z4.^2+(-1).*x1.*z2.*z4.^2+x3.*z2.*z4.^2+x1.*z3.*z4.^2+(-1) ...
  .*x2.*z3.*z4.^2,h.*((-1).*x4.^2.*z1+y3.^2.*z1+(-1).*y4.^2.*z1+ ...
  x3.^2.*(z1+(-1).*z2)+(-2).*x1.*x4.*z2+x4.^2.*z2+(-1).*y3.^2.*z2+ ...
  y4.^2.*z2+(-1).*x1.^2.*z3+2.*x1.*x4.*z3+(-1).*y1.^2.*z3+y2.^2.*z3+ ...
  (-1).*z1.^2.*z3+z2.^2.*z3+z1.*z3.^2+(-1).*z2.*z3.^2+2.*x1.*x3.*( ...
  z2+(-1).*z4)+x2.^2.*(z3+(-1).*z4)+x1.^2.*z4+y1.^2.*z4+(-1).* ...
  y2.^2.*z4+z1.^2.*z4+(-1).*z2.^2.*z4+(-1).*z1.*z4.^2+z2.*z4.^2+2.* ...
  x2.*(x4.*(z1+(-1).*z3)+x3.*((-1).*z1+z4))),h.^2.*(x3.*(z1+(-1).* ...
  z2)+x4.*((-1).*z1+z2)+(x1+(-1).*x2).*(z3+(-1).*z4)),x4.*y2.*z1+( ...
  -1).*x2.*y3.*z1+x4.*y3.*z1+x2.*y4.*z1+(-1).*x4.*y1.*z2+x1.*y3.*z2+ ...
  (-1).*x4.*y3.*z2+(-1).*x1.*y4.*z2+(-1).*x2.*y1.*z3+x4.*y1.*z3+x1.* ...
  y2.*z3+(-1).*x4.*y2.*z3+x1.*y4.*z3+(-1).*x2.*y4.*z3+x2.*y1.*z4+( ...
  -1).*x1.*y2.*z4+(-1).*x1.*y3.*z4+x2.*y3.*z4+x3.*(y4.*((-1).*z1+z2) ...
  +y1.*(z2+(-1).*z4)+y2.*((-1).*z1+z4)),h.*(y4.*(z1+(-1).*z2)+y3.*(( ...
  -1).*z1+z2)+(-1).*(y1+(-1).*y2).*(z3+(-1).*z4))];


ay = coeff_y(1);
by = coeff_y(2);
cy = coeff_y(3);
dy = coeff_y(4);
ey = coeff_y(5);



coeff_z = [(-1).*x2.^2.*x3.*y1+x2.*x3.^2.*y1+x2.^2.*x4.*y1+(-1).*x3.^2.*x4.* ...
  y1+(-1).*x2.*x4.^2.*y1+x3.*x4.^2.*y1+x1.^2.*x3.*y2+(-1).*x1.* ...
  x3.^2.*y2+(-1).*x1.^2.*x4.*y2+x3.^2.*x4.*y2+x1.*x4.^2.*y2+(-1).* ...
  x3.*x4.^2.*y2+x3.*y1.^2.*y2+(-1).*x4.*y1.^2.*y2+(-1).*x3.*y1.* ...
  y2.^2+x4.*y1.*y2.^2+(-1).*x1.^2.*x2.*y3+x1.*x2.^2.*y3+x1.^2.*x4.* ...
  y3+(-1).*x2.^2.*x4.*y3+(-1).*x1.*x4.^2.*y3+x2.*x4.^2.*y3+(-1).* ...
  x2.*y1.^2.*y3+x4.*y1.^2.*y3+x1.*y2.^2.*y3+(-1).*x4.*y2.^2.*y3+x2.* ...
  y1.*y3.^2+(-1).*x4.*y1.*y3.^2+(-1).*x1.*y2.*y3.^2+x4.*y2.*y3.^2+ ...
  x1.^2.*x2.*y4+(-1).*x1.*x2.^2.*y4+(-1).*x1.^2.*x3.*y4+x2.^2.*x3.* ...
  y4+x1.*x3.^2.*y4+(-1).*x2.*x3.^2.*y4+x2.*y1.^2.*y4+(-1).*x3.* ...
  y1.^2.*y4+(-1).*x1.*y2.^2.*y4+x3.*y2.^2.*y4+x1.*y3.^2.*y4+(-1).* ...
  x2.*y3.^2.*y4+(-1).*x2.*y1.*y4.^2+x3.*y1.*y4.^2+x1.*y2.*y4.^2+(-1) ...
  .*x3.*y2.*y4.^2+(-1).*x1.*y3.*y4.^2+x2.*y3.*y4.^2+x3.*y2.*z1.^2+( ...
  -1).*x4.*y2.*z1.^2+(-1).*x2.*y3.*z1.^2+x4.*y3.*z1.^2+x2.*y4.* ...
  z1.^2+(-1).*x3.*y4.*z1.^2+(-1).*x3.*y1.*z2.^2+x4.*y1.*z2.^2+x1.* ...
  y3.*z2.^2+(-1).*x4.*y3.*z2.^2+(-1).*x1.*y4.*z2.^2+x3.*y4.*z2.^2+ ...
  x2.*y1.*z3.^2+(-1).*x4.*y1.*z3.^2+(-1).*x1.*y2.*z3.^2+x4.*y2.* ...
  z3.^2+x1.*y4.*z3.^2+(-1).*x2.*y4.*z3.^2+(-1).*x2.*y1.*z4.^2+x3.* ...
  y1.*z4.^2+x1.*y2.*z4.^2+(-1).*x3.*y2.*z4.^2+(-1).*x1.*y3.*z4.^2+ ...
  x2.*y3.*z4.^2,(-1).*h.*x1.^2.*x3+h.*x2.^2.*x3+h.*x1.*x3.^2+(-1).* ...
  h.*x2.*x3.^2+h.*x1.^2.*x4+(-1).*h.*x2.^2.*x4+(-1).*h.*x1.*x4.^2+ ...
  h.*x2.*x4.^2+(-1).*h.*x3.*y1.^2+h.*x4.*y1.^2+h.*x3.*y2.^2+(-1).* ...
  h.*x4.*y2.^2+2.*h.*x2.*y1.*y3+(-2).*h.*x4.*y1.*y3+(-2).*h.*x1.* ...
  y2.*y3+2.*h.*x4.*y2.*y3+h.*x1.*y3.^2+(-1).*h.*x2.*y3.^2+(-2).*h.* ...
  x2.*y1.*y4+2.*h.*x3.*y1.*y4+2.*h.*x1.*y2.*y4+(-2).*h.*x3.*y2.*y4+( ...
  -1).*h.*x1.*y4.^2+h.*x2.*y4.^2+(-1).*h.*x3.*z1.^2+h.*x4.*z1.^2+h.* ...
  x3.*z2.^2+(-1).*h.*x4.*z2.^2+h.*x1.*z3.^2+(-1).*h.*x2.*z3.^2+(-1) ...
  .*h.*x1.*z4.^2+h.*x2.*z4.^2,h.^2.*x3.*y1+(-1).*h.^2.*x4.*y1+(-1).* ...
  h.^2.*x3.*y2+h.^2.*x4.*y2+h.^2.*x1.*y3+(-1).*h.^2.*x2.*y3+(-1).* ...
  h.^2.*x1.*y4+h.^2.*x2.*y4,(-2).*h.*x2.*x3.*y1+h.*x3.^2.*y1+2.*h.* ...
  x2.*x4.*y1+(-1).*h.*x4.^2.*y1+2.*h.*x1.*x3.*y2+(-1).*h.*x3.^2.*y2+ ...
  (-2).*h.*x1.*x4.*y2+h.*x4.^2.*y2+(-1).*h.*x1.^2.*y3+h.*x2.^2.*y3+ ...
  2.*h.*x1.*x4.*y3+(-2).*h.*x2.*x4.*y3+(-1).*h.*y1.^2.*y3+h.*y2.^2.* ...
  y3+h.*y1.*y3.^2+(-1).*h.*y2.*y3.^2+h.*x1.^2.*y4+(-1).*h.*x2.^2.* ...
  y4+(-2).*h.*x1.*x3.*y4+2.*h.*x2.*x3.*y4+h.*y1.^2.*y4+(-1).*h.* ...
  y2.^2.*y4+(-1).*h.*y1.*y4.^2+h.*y2.*y4.^2+(-1).*h.*y3.*z1.^2+h.* ...
  y4.*z1.^2+h.*y3.*z2.^2+(-1).*h.*y4.*z2.^2+h.*y1.*z3.^2+(-1).*h.* ...
  y2.*z3.^2+(-1).*h.*y1.*z4.^2+h.*y2.*z4.^2,(-2).*h.^2.*x1.*x3+2.* ...
  h.^2.*x2.*x3+2.*h.^2.*x1.*x4+(-2).*h.^2.*x2.*x4+2.*h.^2.*y1.*y3+( ...
  -2).*h.^2.*y2.*y3+(-2).*h.^2.*y1.*y4+2.*h.^2.*y2.*y4,(-1).*h.^2.* ...
  x3.*y1+h.^2.*x4.*y1+h.^2.*x3.*y2+(-1).*h.^2.*x4.*y2+(-1).*h.^2.* ...
  x1.*y3+h.^2.*x2.*y3+h.^2.*x1.*y4+(-1).*h.^2.*x2.*y4];



az = coeff_z(1);
bz = coeff_z(2);
cz = coeff_z(3);
dz = coeff_z(4);
ez = coeff_z(5);
fz = coeff_z(6);


coeffs_poly = [ax.^2+ay.^2+az.^2+2.*az.*bz+bz.^2+cx.^2+2.*az.*cz+2.*bz.*cz+ ...
  cz.^2+2.*cx.*dx.*h+ad.^2.*h.^2+2.*ad.*bd.*h.^2+bd.^2.*h.^2+dx.^2.* ...
  h.^2+2.*ad.*dy.*h.^2+2.*bd.*dy.*h.^2+dy.^2.*h.^2+(-4).*ad.^2.* ...
  l.^2+(-8).*ad.*bd.*l.^2+(-4).*bd.^2.*l.^2+(-4).*ad.*cx.*x1+(-4).* ...
  bd.*cx.*x1+(-4).*ad.*dx.*h.*x1+(-4).*bd.*dx.*h.*x1+4.*ad.^2.* ...
  x1.^2+8.*ad.*bd.*x1.^2+4.*bd.^2.*x1.^2+2.*ax.*(cx+dx.*h+(-2).*(ad+ ...
  bd).*x1)+2.*ay.*(dy.*h+ad.*(h+(-2).*y1)+bd.*(h+(-2).*y1))+(-4).* ...
  ad.^2.*h.*y1+(-8).*ad.*bd.*h.*y1+(-4).*bd.^2.*h.*y1+(-4).*ad.*dy.* ...
  h.*y1+(-4).*bd.*dy.*h.*y1+4.*ad.^2.*y1.^2+8.*ad.*bd.*y1.^2+4.* ...
  bd.^2.*y1.^2+(-4).*ad.*az.*z1+(-4).*az.*bd.*z1+(-4).*ad.*bz.*z1+( ...
  -4).*bd.*bz.*z1+(-4).*ad.*cz.*z1+(-4).*bd.*cz.*z1+4.*ad.^2.*z1.^2+ ...
  8.*ad.*bd.*z1.^2+4.*bd.^2.*z1.^2,4.*(bx.*cx+az.*dz+bz.*dz+cz.*dz+ ...
  az.*ez+bz.*ez+cz.*ez+(-1).*ad.*by.*h+(-1).*bd.*by.*h+(-1).*ad.* ...
  cx.*h+(-1).*bd.*cx.*h+bx.*dx.*h+(-1).*by.*dy.*h+cx.*ex.*h+ad.*cd.* ...
  h.^2+bd.*cd.*h.^2+(-1).*ad.*dx.*h.^2+(-1).*bd.*dx.*h.^2+cd.*dy.* ...
  h.^2+dx.*ex.*h.^2+ad.*ey.*h.^2+bd.*ey.*h.^2+dy.*ey.*h.^2+(-4).* ...
  ad.*cd.*l.^2+(-4).*bd.*cd.*l.^2+(-2).*ad.*bx.*x1+(-2).*bd.*bx.*x1+ ...
  (-2).*cd.*cx.*x1+2.*ad.^2.*h.*x1+4.*ad.*bd.*h.*x1+2.*bd.^2.*h.*x1+ ...
  (-2).*cd.*dx.*h.*x1+(-2).*ad.*ex.*h.*x1+(-2).*bd.*ex.*h.*x1+4.* ...
  ad.*cd.*x1.^2+4.*bd.*cd.*x1.^2+ax.*(bx+(-1).*ad.*h+(-1).*bd.*h+ ...
  ex.*h+(-2).*cd.*x1)+2.*ad.*by.*y1+2.*bd.*by.*y1+(-4).*ad.*cd.*h.* ...
  y1+(-4).*bd.*cd.*h.*y1+(-2).*cd.*dy.*h.*y1+(-2).*ad.*ey.*h.*y1+( ...
  -2).*bd.*ey.*h.*y1+4.*ad.*cd.*y1.^2+4.*bd.*cd.*y1.^2+ay.*((-1).* ...
  by+cd.*h+ey.*h+(-2).*cd.*y1)+(-2).*az.*cd.*z1+(-2).*bz.*cd.*z1+( ...
  -2).*cd.*cz.*z1+(-2).*ad.*dz.*z1+(-2).*bd.*dz.*z1+(-2).*ad.*ez.* ...
  z1+(-2).*bd.*ez.*z1+4.*ad.*cd.*z1.^2+4.*bd.*cd.*z1.^2),4.*(ax.^2+ ...
  ay.^2+az.^2+bx.^2+by.^2+az.*bz+(-1).*cx.^2+(-1).*bz.*cz+(-1).* ...
  cz.^2+dz.^2+2.*dz.*ez+ez.^2+2.*az.*fz+2.*bz.*fz+2.*cz.*fz+(-2).* ...
  ad.*bx.*h+(-2).*bd.*bx.*h+(-2).*by.*cd.*h+(-2).*cd.*cx.*h+2.*ad.* ...
  cy.*h+2.*bd.*cy.*h+(-1).*cx.*dx.*h+2.*cy.*dy.*h+2.*bx.*ex.*h+(-2) ...
  .*by.*ey.*h+ad.^2.*h.^2+ad.*bd.*h.^2+cd.^2.*h.^2+(-2).*cd.*dx.* ...
  h.^2+(-1).*bd.*dy.*h.^2+(-2).*ad.*ex.*h.^2+(-2).*bd.*ex.*h.^2+ ...
  ex.^2.*h.^2+2.*cd.*ey.*h.^2+ey.^2.*h.^2+(-4).*ad.^2.*l.^2+(-4).* ...
  ad.*bd.*l.^2+(-4).*cd.^2.*l.^2+(-4).*bx.*cd.*x1+2.*bd.*cx.*x1+8.* ...
  ad.*cd.*h.*x1+8.*bd.*cd.*h.*x1+(-2).*ad.*dx.*h.*x1+(-4).*cd.*ex.* ...
  h.*x1+4.*ad.^2.*x1.^2+4.*ad.*bd.*x1.^2+4.*cd.^2.*x1.^2+ax.*((-2).* ...
  cd.*h+dx.*h+(-2).*(2.*ad+bd).*x1)+4.*by.*cd.*y1+(-4).*ad.*cy.*y1+( ...
  -4).*bd.*cy.*y1+(-2).*ad.^2.*h.*y1+2.*bd.^2.*h.*y1+(-4).*cd.^2.* ...
  h.*y1+(-2).*ad.*dy.*h.*y1+(-4).*cd.*ey.*h.*y1+4.*ad.^2.*y1.^2+4.* ...
  ad.*bd.*y1.^2+4.*cd.^2.*y1.^2+ay.*(2.*cy+dy.*h+ad.*(h+(-4).*y1)+( ...
  -2).*bd.*y1)+(-4).*ad.*az.*z1+(-2).*az.*bd.*z1+(-2).*ad.*bz.*z1+ ...
  2.*bd.*cz.*z1+(-4).*cd.*dz.*z1+(-4).*cd.*ez.*z1+(-4).*ad.*fz.*z1+( ...
  -4).*bd.*fz.*z1+4.*ad.^2.*z1.^2+4.*ad.*bd.*z1.^2+4.*cd.^2.*z1.^2), ...
  (-4).*(bx.*cx+4.*by.*cy+(-3).*az.*dz+(-1).*bz.*dz+cz.*dz+(-1).* ...
  az.*ez+bz.*ez+3.*cz.*ez+(-4).*dz.*fz+(-4).*ez.*fz+ad.*by.*h+(-1).* ...
  bd.*by.*h+4.*bx.*cd.*h+(-1).*ad.*cx.*h+(-3).*bd.*cx.*h+(-4).*cd.* ...
  cy.*h+(-1).*bx.*dx.*h+by.*dy.*h+3.*cx.*ex.*h+(-4).*cy.*ey.*h+(-3) ...
  .*ad.*cd.*h.^2+(-1).*bd.*cd.*h.^2+ad.*dx.*h.^2+(-1).*bd.*dx.*h.^2+ ...
  cd.*dy.*h.^2+4.*cd.*ex.*h.^2+dx.*ex.*h.^2+ad.*ey.*h.^2+3.*bd.*ey.* ...
  h.^2+dy.*ey.*h.^2+12.*ad.*cd.*l.^2+4.*bd.*cd.*l.^2+6.*ad.*bx.*x1+ ...
  2.*bd.*bx.*x1+(-2).*cd.*cx.*x1+(-6).*ad.^2.*h.*x1+(-4).*ad.*bd.* ...
  h.*x1+2.*bd.^2.*h.*x1+(-8).*cd.^2.*h.*x1+2.*cd.*dx.*h.*x1+2.*ad.* ...
  ex.*h.*x1+(-2).*bd.*ex.*h.*x1+(-12).*ad.*cd.*x1.^2+(-4).*bd.*cd.* ...
  x1.^2+ax.*((-3).*bx+3.*ad.*h+bd.*h+(-1).*ex.*h+6.*cd.*x1)+(-6).* ...
  ad.*by.*y1+(-2).*bd.*by.*y1+8.*cd.*cy.*y1+4.*ad.*cd.*h.*y1+(-4).* ...
  bd.*cd.*h.*y1+2.*cd.*dy.*h.*y1+2.*ad.*ey.*h.*y1+(-2).*bd.*ey.*h.* ...
  y1+(-12).*ad.*cd.*y1.^2+(-4).*bd.*cd.*y1.^2+ay.*(3.*by+(-1).*cd.* ...
  h+(-1).*ey.*h+6.*cd.*y1)+6.*az.*cd.*z1+2.*bz.*cd.*z1+(-2).*cd.* ...
  cz.*z1+6.*ad.*dz.*z1+2.*bd.*dz.*z1+2.*ad.*ez.*z1+(-2).*bd.*ez.*z1+ ...
  8.*cd.*fz.*z1+(-12).*ad.*cd.*z1.^2+(-4).*bd.*cd.*z1.^2),2.*(3.* ...
  ax.^2+3.*ay.^2+3.*az.^2+4.*bx.^2+4.*by.^2+(-1).*bz.^2+3.*cx.^2+8.* ...
  cy.^2+(-2).*az.*cz+3.*cz.^2+4.*dz.^2+(-4).*ez.^2+8.*az.*fz+(-8).* ...
  cz.*fz+8.*fz.^2+(-8).*ad.*bx.*h+8.*cd.*cx.*h+(-8).*bd.*cy.*h+3.* ...
  ad.^2.*h.^2+(-1).*bd.^2.*h.^2+4.*cd.^2.*h.^2+(-1).*dx.^2.*h.^2+( ...
  -2).*ad.*dy.*h.^2+(-1).*dy.^2.*h.^2+8.*bd.*ex.*h.^2+(-4).*ex.^2.* ...
  h.^2+(-8).*cd.*ey.*h.^2+(-4).*ey.^2.*h.^2+(-12).*ad.^2.*l.^2+4.* ...
  bd.^2.*l.^2+(-16).*cd.^2.*l.^2+(-16).*bx.*cd.*x1+4.*ad.*cx.*x1+ ...
  32.*ad.*cd.*h.*x1+4.*bd.*dx.*h.*x1+12.*ad.^2.*x1.^2+(-4).*bd.^2.* ...
  x1.^2+16.*cd.^2.*x1.^2+(-2).*ax.*(cx+4.*cd.*h+6.*ad.*x1)+16.*by.* ...
  cd.*y1+(-16).*ad.*cy.*y1+8.*ad.*bd.*h.*y1+4.*bd.*dy.*h.*y1+12.* ...
  ad.^2.*y1.^2+(-4).*bd.^2.*y1.^2+16.*cd.^2.*y1.^2+2.*ay.*(4.*cy+( ...
  -1).*bd.*h+(-6).*ad.*y1)+(-12).*ad.*az.*z1+4.*bd.*bz.*z1+4.*ad.* ...
  cz.*z1+(-16).*cd.*dz.*z1+(-16).*ad.*fz.*z1+12.*ad.^2.*z1.^2+(-4).* ...
  bd.^2.*z1.^2+16.*cd.^2.*z1.^2),4.*((-1).*bx.*cx+(-4).*by.*cy+3.* ...
  az.*dz+(-1).*bz.*dz+(-1).*cz.*dz+(-1).*az.*ez+(-1).*bz.*ez+3.*cz.* ...
  ez+4.*dz.*fz+(-4).*ez.*fz+ad.*by.*h+bd.*by.*h+(-4).*bx.*cd.*h+ad.* ...
  cx.*h+(-3).*bd.*cx.*h+(-4).*cd.*cy.*h+(-1).*bx.*dx.*h+by.*dy.*h+ ...
  3.*cx.*ex.*h+(-4).*cy.*ey.*h+3.*ad.*cd.*h.^2+(-1).*bd.*cd.*h.^2+ ...
  ad.*dx.*h.^2+bd.*dx.*h.^2+(-1).*cd.*dy.*h.^2+4.*cd.*ex.*h.^2+(-1) ...
  .*dx.*ex.*h.^2+(-1).*ad.*ey.*h.^2+3.*bd.*ey.*h.^2+(-1).*dy.*ey.* ...
  h.^2+(-12).*ad.*cd.*l.^2+4.*bd.*cd.*l.^2+(-6).*ad.*bx.*x1+2.*bd.* ...
  bx.*x1+2.*cd.*cx.*x1+6.*ad.^2.*h.*x1+(-4).*ad.*bd.*h.*x1+(-2).* ...
  bd.^2.*h.*x1+8.*cd.^2.*h.*x1+2.*cd.*dx.*h.*x1+2.*ad.*ex.*h.*x1+2.* ...
  bd.*ex.*h.*x1+12.*ad.*cd.*x1.^2+(-4).*bd.*cd.*x1.^2+ax.*(3.*bx+( ...
  -3).*ad.*h+bd.*h+(-1).*ex.*h+(-6).*cd.*x1)+6.*ad.*by.*y1+(-2).* ...
  bd.*by.*y1+(-8).*cd.*cy.*y1+4.*ad.*cd.*h.*y1+4.*bd.*cd.*h.*y1+2.* ...
  cd.*dy.*h.*y1+2.*ad.*ey.*h.*y1+2.*bd.*ey.*h.*y1+12.*ad.*cd.*y1.^2+ ...
  (-4).*bd.*cd.*y1.^2+(-1).*ay.*(3.*by+cd.*h+ey.*h+6.*cd.*y1)+(-6).* ...
  az.*cd.*z1+2.*bz.*cd.*z1+2.*cd.*cz.*z1+(-6).*ad.*dz.*z1+2.*bd.* ...
  dz.*z1+2.*ad.*ez.*z1+2.*bd.*ez.*z1+(-8).*cd.*fz.*z1+12.*ad.*cd.* ...
  z1.^2+(-4).*bd.*cd.*z1.^2),4.*(ax.^2+ay.^2+az.^2+bx.^2+by.^2+(-1) ...
  .*az.*bz+(-1).*cx.^2+bz.*cz+(-1).*cz.^2+dz.^2+(-2).*dz.*ez+ez.^2+ ...
  2.*az.*fz+(-2).*bz.*fz+2.*cz.*fz+(-2).*ad.*bx.*h+2.*bd.*bx.*h+2.* ...
  by.*cd.*h+(-2).*cd.*cx.*h+(-2).*ad.*cy.*h+2.*bd.*cy.*h+cx.*dx.*h+( ...
  -2).*cy.*dy.*h+(-2).*bx.*ex.*h+2.*by.*ey.*h+ad.^2.*h.^2+(-1).*ad.* ...
  bd.*h.^2+cd.^2.*h.^2+2.*cd.*dx.*h.^2+bd.*dy.*h.^2+2.*ad.*ex.*h.^2+ ...
  (-2).*bd.*ex.*h.^2+ex.^2.*h.^2+2.*cd.*ey.*h.^2+ey.^2.*h.^2+(-4).* ...
  ad.^2.*l.^2+4.*ad.*bd.*l.^2+(-4).*cd.^2.*l.^2+(-4).*bx.*cd.*x1+( ...
  -2).*bd.*cx.*x1+8.*ad.*cd.*h.*x1+(-8).*bd.*cd.*h.*x1+2.*ad.*dx.* ...
  h.*x1+4.*cd.*ex.*h.*x1+4.*ad.^2.*x1.^2+(-4).*ad.*bd.*x1.^2+4.* ...
  cd.^2.*x1.^2+(-1).*ax.*(2.*cd.*h+dx.*h+4.*ad.*x1+(-2).*bd.*x1)+4.* ...
  by.*cd.*y1+(-4).*ad.*cy.*y1+4.*bd.*cy.*y1+2.*ad.^2.*h.*y1+(-2).* ...
  bd.^2.*h.*y1+4.*cd.^2.*h.*y1+2.*ad.*dy.*h.*y1+4.*cd.*ey.*h.*y1+4.* ...
  ad.^2.*y1.^2+(-4).*ad.*bd.*y1.^2+4.*cd.^2.*y1.^2+ay.*(2.*cy+(-1).* ...
  dy.*h+2.*bd.*y1+(-1).*ad.*(h+4.*y1))+(-4).*ad.*az.*z1+2.*az.*bd.* ...
  z1+2.*ad.*bz.*z1+(-2).*bd.*cz.*z1+(-4).*cd.*dz.*z1+4.*cd.*ez.*z1+( ...
  -4).*ad.*fz.*z1+4.*bd.*fz.*z1+4.*ad.^2.*z1.^2+(-4).*ad.*bd.*z1.^2+ ...
  4.*cd.^2.*z1.^2),4.*(bx.*cx+az.*dz+(-1).*bz.*dz+cz.*dz+(-1).*az.* ...
  ez+bz.*ez+(-1).*cz.*ez+ad.*by.*h+(-1).*bd.*by.*h+(-1).*ad.*cx.*h+ ...
  bd.*cx.*h+(-1).*bx.*dx.*h+by.*dy.*h+(-1).*cx.*ex.*h+ad.*cd.*h.^2+( ...
  -1).*bd.*cd.*h.^2+ad.*dx.*h.^2+(-1).*bd.*dx.*h.^2+cd.*dy.*h.^2+ ...
  dx.*ex.*h.^2+ad.*ey.*h.^2+(-1).*bd.*ey.*h.^2+dy.*ey.*h.^2+(-4).* ...
  ad.*cd.*l.^2+4.*bd.*cd.*l.^2+(-2).*ad.*bx.*x1+2.*bd.*bx.*x1+(-2).* ...
  cd.*cx.*x1+2.*ad.^2.*h.*x1+(-4).*ad.*bd.*h.*x1+2.*bd.^2.*h.*x1+2.* ...
  cd.*dx.*h.*x1+2.*ad.*ex.*h.*x1+(-2).*bd.*ex.*h.*x1+4.*ad.*cd.* ...
  x1.^2+(-4).*bd.*cd.*x1.^2+ax.*(bx+(-1).*ad.*h+bd.*h+(-1).*ex.*h+( ...
  -2).*cd.*x1)+2.*ad.*by.*y1+(-2).*bd.*by.*y1+4.*ad.*cd.*h.*y1+(-4) ...
  .*bd.*cd.*h.*y1+2.*cd.*dy.*h.*y1+2.*ad.*ey.*h.*y1+(-2).*bd.*ey.* ...
  h.*y1+4.*ad.*cd.*y1.^2+(-4).*bd.*cd.*y1.^2+(-1).*ay.*(by+cd.*h+ ...
  ey.*h+2.*cd.*y1)+(-2).*az.*cd.*z1+2.*bz.*cd.*z1+(-2).*cd.*cz.*z1+( ...
  -2).*ad.*dz.*z1+2.*bd.*dz.*z1+2.*ad.*ez.*z1+(-2).*bd.*ez.*z1+4.* ...
  ad.*cd.*z1.^2+(-4).*bd.*cd.*z1.^2),ax.^2+ay.^2+az.^2+(-2).*az.*bz+ ...
  bz.^2+cx.^2+2.*az.*cz+(-2).*bz.*cz+cz.^2+(-2).*cx.*dx.*h+ad.^2.* ...
  h.^2+(-2).*ad.*bd.*h.^2+bd.^2.*h.^2+dx.^2.*h.^2+2.*ad.*dy.*h.^2+( ...
  -2).*bd.*dy.*h.^2+dy.^2.*h.^2+(-4).*ad.^2.*l.^2+8.*ad.*bd.*l.^2+( ...
  -4).*bd.^2.*l.^2+(-4).*ad.*cx.*x1+4.*bd.*cx.*x1+4.*ad.*dx.*h.*x1+( ...
  -4).*bd.*dx.*h.*x1+4.*ad.^2.*x1.^2+(-8).*ad.*bd.*x1.^2+4.*bd.^2.* ...
  x1.^2+2.*ax.*(cx+(-1).*dx.*h+2.*((-1).*ad+bd).*x1)+4.*ad.^2.*h.* ...
  y1+(-8).*ad.*bd.*h.*y1+4.*bd.^2.*h.*y1+4.*ad.*dy.*h.*y1+(-4).*bd.* ...
  dy.*h.*y1+4.*ad.^2.*y1.^2+(-8).*ad.*bd.*y1.^2+4.*bd.^2.*y1.^2+(-2) ...
  .*ay.*(dy.*h+ad.*(h+2.*y1)+(-1).*bd.*(h+2.*y1))+(-4).*ad.*az.*z1+ ...
  4.*az.*bd.*z1+4.*ad.*bz.*z1+(-4).*bd.*bz.*z1+(-4).*ad.*cz.*z1+4.* ...
  bd.*cz.*z1+4.*ad.^2.*z1.^2+(-8).*ad.*bd.*z1.^2+4.*bd.^2.*z1.^2];


%solve for theta
syms f(n)
f(n) = coeffs_poly(1) +  coeffs_poly(2)*n +  coeffs_poly(3)*n^2 + ...
     coeffs_poly(4)*n^3 +  coeffs_poly(5)*n^4 +  coeffs_poly(6)*n^5 + ...
     coeffs_poly(7)*n^6 + coeffs_poly(8)*n^7 + coeffs_poly(9)*n^8;
sol = vpasolve(f);


possible_idx = (1:length(double(sol)));
idx_real_solutions = possible_idx(imag(double(sol))==0);

if ~isempty(idx_real_solutions)
    numsol = strcat("There are ", num2str(length(idx_real_solutions)), " real solutions.");
    disp(numsol);
    
    for i = idx_real_solutions
        theta = 2*atan(sol(i));

        x =(1/2).*(ad+bd.*cos(theta)+cd.*sin(theta)).^(-1).*(ax+cx.*cos(theta).^2+bx.* ...
          sin(theta)+h.*cos(theta).*(dx+ex.*sin(theta)));

        y = (1/2).*(ad+bd.*cos(theta)+cd.*sin(theta)).^(-1).*(ay+(-1).*by.*sin(theta)+cy.* ...
          sin(theta).^2+h.*cos(theta).*(dy+ey.*sin(theta)));

        z = (1/2).*(ad+bd.*cos(theta)+cd.*sin(theta)).^(-1).*(az+bz.*cos(theta)+cz.*cos(theta) ...
          .^2+(dz+ez.*cos(theta)).*sin(theta)+fz.*sin(theta).^2);
      
        xval = strcat("solution ", num2str(i), ", x: ", num2str(double(x)));
        yval = strcat("solution ", num2str(i), ", y: ", num2str(double(y)));
        zval = strcat("solution ", num2str(i), ", z: ", num2str(double(z)));
        thetaval = strcat("solution ", num2str(i), ", theta: ", num2str(double(theta)));
        
        disp(xval)
        disp(yval)
        disp(zval)
        disp(thetaval)
        
    end
else
    msg = 'No real solutions. Cannot solve.';
    error(msg)
end

end